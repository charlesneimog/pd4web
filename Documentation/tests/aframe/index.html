<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>AFRAME - detectar movimento da câmera</title>
        <script src="./pd4web.threads.js"></script>
        <!-- Main modules -->
        <script src="./pd4web.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.7.0/aframe.min.js" integrity="sha512-QRe0tMdbQUsh9BJOh+ijnsJaLoO68ku2a9/7HmQCIvqpeWRkqc4Ee0Ohjvt6y7Fx/ShFTLoL/H3ZgxZrXB7ERA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>

    <body>
        <a-scene>
            <a-box position="0 1 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
            <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
            <a-light type="point" position="2 4 -2" intensity="1"></a-light>

            <!-- câmera com look-controls -->
            <a-entity id="playerCam" camera look-controls position="0 1.6 0"></a-entity>
        </a-scene>

        <script>
            var Pd4Web = null;
            Pd4WebModule().then((Pd4WebModulePromise) => {
                Pd4Web = new Pd4WebModulePromise.Pd4Web();
                Pd4Web.openPatch("index.pd", {
                    renderGui: false,
                });
                document.addEventListener(
                    "click",
                    () => {
                        Pd4Web.init();
                        setTimeout(() => {
                            Pd4Web.sendSymbol("audio2play", "revisao2.wav");
                        }, 1000);
                    },
                    { once: true },
                );
            });

            AFRAME.registerComponent("watch-transform", {
                schema: {
                    eps: { type: "number", default: 0.0005 }, // limiar para evitar ruído
                },

                init: function () {
                    this.obj = this.el.object3D;
                    this.prevPos = new THREE.Vector3().copy(this.obj.position);
                    this.prevRot = new THREE.Euler().copy(this.obj.rotation);
                },

                // chamado todo frame
                tick: function () {
                    const p = this.obj.position;
                    const r = this.obj.rotation;
                    // send to pd4web

                    if (Pd4Web) {
                        Pd4Web.sendFloat("x", r.x);
                        Pd4Web.sendFloat("y", r.y);
                        Pd4Web.sendFloat("z", r.z);
                    }
                },
            });

            // espera a cena carregar e então anexa o componente na câmera
            window.addEventListener("load", () => {
                const scene = document.querySelector("a-scene");
                if (!scene.hasLoaded) {
                    scene.addEventListener("loaded", attachWatcher);
                } else {
                    attachWatcher();
                }

                function attachWatcher() {
                    const cam = document.getElementById("playerCam");
                    // sensibilidade
                    cam.setAttribute("watch-transform", "eps: 0.0008");
                }

                async function loadRemoteAudio(url) {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error("Failed to download audio");
                    const arrayBuffer = await res.arrayBuffer();
                    const fileName = url.split("/").pop();
                    const uint8 = new Uint8Array(arrayBuffer);
                    Pd4Web.sendFile(uint8, fileName);
                    console.log("OK:", fileName, uint8.byteLength);
                }

                loadRemoteAudio("./revisao2.wav");
            });
        </script>
    </body>
</html>
