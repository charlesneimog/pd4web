name: pd4web-compiler
on:
  workflow_dispatch:
    inputs:
      publish_pypi:
        description: "Publish built wheels to PyPI"
        required: false
        default: false
        type: boolean

env:
  BUILD_TYPE: Release

jobs:
  pd4web-compiler:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15-intel, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # Cache build deps everywhere; ccache dir only on non-Windows
      - name: Cache CMake and dependencies
        id: build-cache
        uses: actions/cache@v4
        with:
          path: |
            build/_deps
            build/CMakeCache.txt
            build/CMakeFiles
            ${{ runner.os != 'Windows' && '~/.ccache' || '' }}
            ${{ runner.os == 'Windows' && '~/AppData/Local/ccache' || '' }}
          key: build-cv11-${{ matrix.os }}-${{ runner.arch }}-${{ env.BUILD_TYPE }}-${{ hashFiles('CMakeLists.txt', '**/*.cmake', '**/pyproject.toml') }}
          restore-keys: |
            build-cv11-${{ matrix.os }}-${{ runner.arch }}-${{ env.BUILD_TYPE }}-
            build-cv11-${{ matrix.os }}-${{ runner.arch }}-

      - name: Clean build artifacts (keep dependencies)
        shell: bash
        run: |
          if [ -d "build" ]; then
            find build -type f \( -name "*.o" -o -name "*.obj" -o -name "*.a" -o -name "*.lib" -o -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) -delete 2>/dev/null || true
          fi
          mkdir -p build

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1

      - name: Install Perl and Ninja (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install strawberryperl -y
          choco install ninja -y

      - name: Install PureData for Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          winget install -e --id MillerPuckette.PureData --accept-source-agreements --accept-package-agreements

      - name: Install PureData for macOS
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install --cask pd
          brew install ccache
          brew install git
          brew uninstall --ignore-dependencies openssl@3

      - name: Install PureData for Linux
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common ccache
          sudo add-apt-repository ppa:pure-data/pure-data -y || true
          sudo apt-get update
          sudo apt-get install -y puredata

      - name: Configure ccache (macOS/Linux)
        if: runner.os != 'Windows'
        run: |
          ccache --set-config=max_size=500M
          ccache --set-config=compression=true
          ccache -z

      - name: Install Python Packages
        run: |
          pip install build --break-system-packages

      - name: Build wheels
        run: |
          python -m pip install build --break-system-packages
          python -m build --wheel

      - name: Show ccache stats (macOS/Linux)
        if: runner.os != 'Windows'
        run: ccache -s

      - name: Repair Linux wheels
        if: ${{ github.event.inputs.publish_pypi == 'true' && runner.os == 'Linux' }}
        run: |
          python -m pip install auditwheel
          auditwheel repair dist/*.whl -w dist/
          rm dist/*-linux_*.whl

      - name: Upload PureData Object
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}
          path: build/pd4web

      - name: Upload Python Module
        uses: actions/upload-artifact@v4
        with:
          name: pypd4web-${{ matrix.os }}
          path: dist/*.whl

  publish-pypi:
    if: ${{ github.event.inputs.publish_pypi == 'true' }}
    needs: pd4web-compiler
    runs-on: ubuntu-latest
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: pypd4web-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          packages-dir: dist
