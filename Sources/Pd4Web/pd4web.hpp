#pragma once

#if !defined(__EMSCRIPTEN__)
#error "This module requires Emscripten."
#endif

// Standard C++ Libraries
#include <algorithm>
#include <format>
#include <iostream>
#include <sstream>
#include <mutex>
#include <condition_variable>
#include <tuple>

// Emscripten APIs
#include <emscripten.h>
#include <emscripten/bind.h>
#include <emscripten/val.h>
#include <emscripten/webaudio.h>

// Pure Data (libpd) Headers
#include <z_libpd.h>
#include <z_print_util.h>
#include <z_queued.h>
#include <g_canvas.h>

// Local project headers
#include "config.h"

// External initialization function
extern void Pd4WebInitExternals(); // defined in externals.cpp (generated by pd4web compiler)

// ╭─────────────────────────────────────╮
// │            Pd4Web Lua Support       │
// ╰─────────────────────────────────────╯
#if PD4WEB_LUA
extern "C" {
#include <lua.h>
#include <lauxlib.h>
#include <lualib.h>
#include <pdlua.h>

extern lua_State *__L();
extern int pd4weblua_draw();
extern void pdlua_setup();
}
#endif

// ╭─────────────────────────────────────╮
// │            Graphics / GL Setup      │
// ╰─────────────────────────────────────╯
#include <GLES3/gl3.h>

#define NANOVG_GLES3_IMPLEMENTATION
#include <nanovg.h>
#include <nanovg_gl.h>
#include <nanovg_gl_utils.h>

// ────────── User Data Struct ──────────
enum Pd4WebSenderType { BANG = 0, FLOAT, SYMBOL, LIST, MESSAGE };

struct Pd4WebUserData {
    class Pd4Web *pd4web;
    t_pdinstance *libpd;

    NVGLUframebuffer *invalidFBO;

    // Sound state
    bool soundInit;
    bool soundSuspended;
    std::string soundToggleSel;

    // Canvas selection
    std::string canvasSel;

    // Audio processing synchronization
    std::mutex mtx;
    std::condition_variable cv;
    bool drawing = false;
    bool processing = false;

    // Mouse state
    bool mousedown;
    bool doit;
    int xpos;
    int ypos;
    int canvas_width;
    int canvas_height;
    float devicePixelRatio;
    t_gobj *obj;
    t_canvas *canvas;

    // Keyboard input
    std::string key;

    // Rendering optimization
    bool first_frame = true;
    int font_handler = 0;
    EMSCRIPTEN_WEBGL_CONTEXT_HANDLE ctx;
    NVGcontext *vg;
    bool contextReady = false;
};

// ─────────── PdLua Graphics ───────────

struct PdLuaObjGuiLayer {
    bool dirty = false;
    bool drawing = false;

    // pdlua
    std::string layer_id;
    std::vector<GuiCommand> gui_commands;
    int size;

    // framebuffer
    int objx;
    int objy;
    int objw;
    int objh;
    NVGLUframebuffer *fb = nullptr;
    float last_zoom = 0; // Track last zoom to detect changes
};
using PdLuaObjLayers = std::unordered_map<int, PdLuaObjGuiLayer>;
using PdLuaObjsGui = std::unordered_map<std::string, PdLuaObjLayers>;
using PdInstanceGui = std::unordered_map<t_pdinstance *, PdLuaObjsGui>;

// ─────── Senders and Receivers ────
struct Pd4WebSender {
    const char *receiver;
    Pd4WebSenderType type;
    float f;
    const char *m;
};

static std::unordered_map<t_pdinstance *, std::unordered_map<std::string, emscripten::val>>
    ReceiverListeners;

using ReceiverMap = std::unordered_map<std::string, emscripten::val>;
using Pd4WebReceiverListeners = std::unordered_map<t_pdinstance *, ReceiverMap>;

static Pd4WebReceiverListeners BangReceiverListeners;
static Pd4WebReceiverListeners FloatReceiverListeners;
static Pd4WebReceiverListeners SymbolReceiverListeners;
static Pd4WebReceiverListeners ListReceiverListeners;

// ╭─────────────────────────────────────╮
// │             Main Class              │
// ╰─────────────────────────────────────╯
template <typename T> class Rectangle {
  public:
    Rectangle() : x(0), y(0), width(0), height(0) {}
    Rectangle(T x_, T y_, T w_, T h_) : x(x_), y(y_), width(w_), height(h_) {}

    T getX() const {
        return x;
    }
    T getY() const {
        return y;
    }
    T getWidth() const {
        return width;
    }
    T getHeight() const {
        return height;
    }

    void setBounds(T x_, T y_, T w_, T h_) {
        x = x_;
        y = y_;
        width = w_;
        height = h_;
    }

    bool isEmpty() const {
        return width <= 0 || height <= 0;
    }

  private:
    T x, y, width, height;
};

class Pd4Web {
  public:
    ~Pd4Web() {
        libpd_free_instance(m_NewPdInstance);
    }

    // Main
    void init();
    void suspendAudio();
    void openPatchJS(const std::string &patchPath, emscripten::val options);

    // send Messages
    void sendFloat(std::string r, float f);
    void sendSymbol(std::string r, std::string s);
    void sendBang(std::string r);
    void sendList(const std::string &r, emscripten::val jsArray);
    void sendMessage(const std::string &r, const std::string &s, emscripten::val jsArray);

    // bind
    void onBangReceived(std::string r, emscripten::val func);
    void onFloatReceived(std::string r, emscripten::val func);
    void onSymbolReceived(std::string r, emscripten::val func);
    void onListReceived(std::string r, emscripten::val func);

    // Mouse Position
    void getLastMousePosition(int *x, int *y);
    void setLastMousePosition(int x, int y);

    // WebAudioContext
    EMSCRIPTEN_WEBAUDIO_T getWebAudioContext();
    void setWebAudioContext(EMSCRIPTEN_WEBAUDIO_T ctx);

    //
    Rectangle<int> invalidArea;

  private:
    void openPatch(std::string PatchPath, std::string PatchCanvaId, std::string soundToggleId);
    void startMidi();

    // Theme
    bool m_ThemeDefined = false;
    bool m_DarkTheme = false;

    // This make the class destructor free this memory
    std::unique_ptr<Pd4WebUserData> m_SoundBtn;
    std::unique_ptr<Pd4WebUserData> m_EventCtx;
    std::unique_ptr<Pd4WebUserData> m_GuiLoopCtx;

    std::string canvasId;
    bool m_Pd4WebInit = false;
    bool m_PdInit = false;
    bool m_audioSuspended = false;

    t_pdinstance *m_NewPdInstance;
    EMSCRIPTEN_WEBAUDIO_T m_Context;

    // mouse
    int m_LastMouseX;
    int m_LastMouseY;
};

// ╭─────────────────────────────────────╮
// │           Function Prototypes       │
// ╰─────────────────────────────────────╯
void loop(void *userData);
void create_webgl_context(Pd4WebUserData *ud);

// ╭─────────────────────────────────────╮
// │  Bind C++ functions to JavaScript   │
// ╰─────────────────────────────────────╯
void onMIDISuccess(emscripten::val midiAccess);
void onMIDIFailed(emscripten::val error);
void onMIDIInMessage(emscripten::val event);
void onMIDIOutMessage(emscripten::val event);

EMSCRIPTEN_BINDINGS(Pd4WebModule) {
    function("onMIDISuccess", &onMIDISuccess);
    function("onMIDIFailed", &onMIDIFailed);
    function("onMIDIInMessage", &onMIDIInMessage);
    function("onMIDIOutMessage", &onMIDIOutMessage);

    emscripten::class_<Pd4Web>("Pd4Web")
        .constructor<>() // Default constructor
        .function("openPatch", &Pd4Web::openPatchJS)
        .function("suspendAudio", &Pd4Web::suspendAudio)

        // senders
        .function("sendBang", &Pd4Web::sendBang)
        .function("sendFloat", &Pd4Web::sendFloat)
        .function("sendSymbol", &Pd4Web::sendSymbol)
        .function("sendList", &Pd4Web::sendList)
        .function("sendMessage", &Pd4Web::sendMessage)

        // bind and unbind receivers
        .function("onBangReceived", &Pd4Web::onBangReceived)
        .function("onFloatReceived", &Pd4Web::onFloatReceived)
        .function("onSymbolReceived", &Pd4Web::onSymbolReceived)
        .function("onListReceived", &Pd4Web::onListReceived);
}
